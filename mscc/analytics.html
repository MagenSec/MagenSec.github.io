<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cost & Performance - MagenSec Command Center</title>
    <link rel="icon" type="image/png" href="../assets/favicon.png">
    
    <!-- Tabler CSS -->
    <link href="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta17/dist/css/tabler.min.css" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/@tabler/icons@latest/icons-sprite.svg" rel="stylesheet"/>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    
    <style>
        .cost-card {
            transition: all 0.2s;
        }
        
        .cost-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 25px rgba(0,0,0,0.1);
        }
        
        .chart-container {
            position: relative;
            height: 300px;
        }
        
        .chart-container.large {
            height: 400px;
        }
        
        .cost-indicator {
            font-size: 2rem;
            font-weight: bold;
        }
        
        .cost-savings { color: var(--tblr-success); }
        .cost-increase { color: var(--tblr-danger); }
        .cost-neutral { color: var(--tblr-muted); }
        
        .performance-score {
            font-size: 2.5rem;
            font-weight: bold;
        }
        
        .score-excellent { color: var(--tblr-success); }
        .score-good { color: var(--tblr-success); }
        .score-fair { color: var(--tblr-warning); }
        .score-poor { color: var(--tblr-danger); }
        
        .filter-bar {
            background: var(--tblr-bg-surface);
            border-radius: var(--tblr-border-radius);
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .cost-breakdown-item {
            border-left: 4px solid;
            margin-bottom: 0.5rem;
        }
        
        .cost-license { border-left-color: var(--tblr-primary); }
        .cost-infrastructure { border-left-color: var(--tblr-success); }
        .cost-support { border-left-color: var(--tblr-warning); }
        .cost-training { border-left-color: var(--tblr-info); }
        .cost-incident { border-left-color: var(--tblr-danger); }
        
        .performance-metric {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: var(--tblr-bg-surface);
            border-radius: var(--tblr-border-radius);
        }
        
        .metric-gauge {
            width: 60px;
            height: 60px;
            position: relative;
        }
        
        .roi-positive { color: var(--tblr-success); }
        .roi-negative { color: var(--tblr-danger); }
        
        .export-options {
            background: var(--tblr-bg-surface);
            border-radius: var(--tblr-border-radius);
            padding: 1rem;
            margin-bottom: 1rem;
        }
    </style>
</head>
<body>
    <div class="page">
        <!-- Navigation Header -->
        <header class="navbar navbar-expand-md navbar-dark d-print-none">
            <div class="container-xl">
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar-menu" aria-controls="navbar-menu" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <h1 class="navbar-brand navbar-brand-autodark d-none-navbar-horizontal pe-0 pe-md-3">
                    <a href="dashboard.html">
                        <img src="../assets/logo.png" alt="MagenSec" class="navbar-brand-image" style="height: 32px; margin-right: 0.5rem;">
                        MagenSec
                    </a>
                </h1>
                <div class="navbar-nav flex-row order-md-last">
                    <div class="nav-item dropdown">
                        <a href="#" class="nav-link d-flex lh-1 text-reset p-0" data-bs-toggle="dropdown" aria-label="Open user menu">
                            <span id="userAvatar" class="avatar avatar-sm"></span>
                            <div class="d-none d-xl-block ps-2">
                                <div id="userName">User</div>
                                <div id="userRole" class="mt-1 small text-muted">Role</div>
                            </div>
                        </a>
                        <div class="dropdown-menu dropdown-menu-end dropdown-menu-arrow">
                            <a href="dashboard.html" class="dropdown-item">Dashboard</a>
                            <a href="#" class="dropdown-item">Settings</a>
                            <div class="dropdown-divider"></div>
                            <a href="#" class="dropdown-item" onclick="logout()">Logout</a>
                        </div>
                    </div>
                </div>
                <div class="collapse navbar-collapse" id="navbar-menu">
                    <div class="d-flex flex-column flex-md-row flex-fill align-items-stretch align-items-md-center">
                        <ul class="navbar-nav">
                            <li class="nav-item">
                                <a class="nav-link" href="dashboard.html">
                                    <span class="nav-link-icon d-md-none d-lg-inline-block">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                            <rect x="4" y="4" width="6" height="8" rx="1"/>
                                            <rect x="4" y="16" width="6" height="4" rx="1"/>
                                            <rect x="14" y="4" width="6" height="4" rx="1"/>
                                            <rect x="14" y="12" width="6" height="8" rx="1"/>
                                        </svg>
                                    </span>
                                    <span class="nav-link-title">Dashboard</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="devices.html">
                                    <span class="nav-link-icon d-md-none d-lg-inline-block">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                            <rect x="3" y="4" width="18" height="12" rx="1"/>
                                            <line x1="7" y1="20" x2="17" y2="20"/>
                                            <line x1="9" y1="16" x2="15" y2="16"/>
                                        </svg>
                                    </span>
                                    <span class="nav-link-title">Devices</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="security.html">
                                    <span class="nav-link-icon d-md-none d-lg-inline-block">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                            <path d="M12 3a12 12 0 0 0 8.5 3a12 12 0 0 1 -8.5 15a12 12 0 0 1 -8.5 -15a12 12 0 0 0 8.5 -3"/>
                                        </svg>
                                    </span>
                                    <span class="nav-link-title">Security</span>
                                </a>
                            </li>
                            <li class="nav-item active business-only">
                                <a class="nav-link" href="analytics.html">
                                    <span class="nav-link-icon d-md-none d-lg-inline-block">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                            <polyline points="22,12 18,12 15,21 9,3 6,12 2,12"/>
                                        </svg>
                                    </span>
                                    <span class="nav-link-title">Analytics</span>
                                </a>
                            </li>
                            <li id="adminNav" class="nav-item" style="display: none;">
                                <a class="nav-link" href="admin.html">
                                    <span class="nav-link-icon d-md-none d-lg-inline-block">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                            <circle cx="12" cy="12" r="3"/>
                                            <path d="M12 1v6m0 6v6"/>
                                            <path d="M21 12h-6m-6 0H3"/>
                                        </svg>
                                    </span>
                                    <span class="nav-link-title">Administration</span>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </header>
        
        <!-- Page Content -->
        <div class="page-wrapper">
            <div class="page-header d-print-none">
                <div class="container-xl">
                    <div class="row g-2 align-items-center">
                        <div class="col">
                            <h2 class="page-title">Cost & Performance Analytics</h2>
                            <div class="text-muted mt-1" id="analyticsSummary">Financial and performance insights</div>
                        </div>
                        <div class="col-auto ms-auto d-print-none">
                            <div class="btn-list">
                                <div class="dropdown">
                                    <button class="btn btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                            <path d="M14 3v4a1 1 0 0 0 1 1h4"/>
                                            <path d="M17 21h-10a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2z"/>
                                        </svg>
                                        Export
                                    </button>
                                    <div class="dropdown-menu">
                                        <a class="dropdown-item" href="#" onclick="exportReport('pdf')">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                                <path d="M14 3v4a1 1 0 0 0 1 1h4"/>
                                                <path d="M17 21h-10a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2z"/>
                                            </svg>
                                            PDF Report
                                        </a>
                                        <a class="dropdown-item" href="#" onclick="exportReport('excel')">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
                                                <path d="M9 9h6v6h-6z"/>
                                            </svg>
                                            Excel Workbook
                                        </a>
                                        <a class="dropdown-item" href="#" onclick="exportReport('csv')">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                                <rect x="4" y="4" width="16" height="16" rx="2"/>
                                                <path d="M8 12h8"/>
                                                <path d="M8 16h8"/>
                                                <path d="M8 8h8"/>
                                            </svg>
                                            CSV Data
                                        </a>
                                    </div>
                                </div>
                                <button class="btn btn-primary" onclick="refreshData()">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                        <path d="M19.933 13.041a8 8 0 1 1 -9.925 -8.788c3.899 -1 7.935 1.007 9.425 4.747"/>
                                        <path d="M20 4v5h-5"/>
                                    </svg>
                                    Refresh
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="page-body">
                <div class="container-xl">
                    <!-- Filter Bar -->
                    <div class="filter-bar">
                        <div class="row g-3 align-items-center">
                            <div class="col-md-3">
                                <label class="form-label">Time Period</label>
                                <select class="form-select" id="timePeriodFilter" onchange="updateAnalytics()">
                                    <option value="current-month">Current Month</option>
                                    <option value="last-month">Last Month</option>
                                    <option value="quarter">This Quarter</option>
                                    <option value="year">This Year</option>
                                    <option value="custom">Custom Range</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">View Type</label>
                                <select class="form-select" id="viewTypeFilter" onchange="updateAnalytics()">
                                    <option value="combined">Cost & Performance</option>
                                    <option value="cost-only">Cost Analysis</option>
                                    <option value="performance-only">Performance Only</option>
                                    <option value="roi-focus">ROI Analysis</option>
                                </select>
                            </div>
                            <div id="businessFilters" class="col-md-3 business-only" style="display: none;">
                                <label class="form-label">Department</label>
                                <select class="form-select" id="departmentFilter" onchange="updateAnalytics()">
                                    <option value="all">All Departments</option>
                                    <option value="it">IT Department</option>
                                    <option value="hr">Human Resources</option>
                                    <option value="finance">Finance</option>
                                    <option value="operations">Operations</option>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">Currency</label>
                                <select class="form-select" id="currencyFilter" onchange="updateAnalytics()">
                                    <option value="usd">USD ($)</option>
                                    <option value="eur">EUR (€)</option>
                                    <option value="gbp">GBP (£)</option>
                                    <option value="cad">CAD (C$)</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Cost Overview -->
                    <div class="row mb-4">
                        <div class="col-sm-6 col-lg-3">
                            <div class="card cost-card">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="subheader">Monthly Cost</div>
                                        <div class="ms-auto">
                                            <span id="costChange" class="cost-savings">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-sm" width="16" height="16" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                                    <polyline points="7,13 12,8 17,13"/>
                                                    <polyline points="12,8 12,21"/>
                                                </svg>
                                                -8%
                                            </span>
                                        </div>
                                    </div>
                                    <div class="cost-indicator" id="monthlyCost">$1,247</div>
                                    <div class="text-muted small">vs last month</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-sm-6 col-lg-3">
                            <div class="card cost-card">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="subheader">Cost per Device</div>
                                        <div class="ms-auto">
                                            <span id="perDeviceCostChange" class="cost-neutral">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-sm" width="16" height="16" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                                    <line x1="5" y1="12" x2="19" y2="12"/>
                                                </svg>
                                                0%
                                            </span>
                                        </div>
                                    </div>
                                    <div class="cost-indicator" id="costPerDevice">$26.53</div>
                                    <div class="text-muted small">per device/month</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-sm-6 col-lg-3">
                            <div class="card cost-card">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="subheader">Performance Score</div>
                                        <div class="ms-auto">
                                            <span id="performanceChange" class="cost-savings">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-sm" width="16" height="16" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                                    <polyline points="7,11 12,6 17,11"/>
                                                    <polyline points="12,18 12,6"/>
                                                </svg>
                                                +12%
                                            </span>
                                        </div>
                                    </div>
                                    <div class="performance-score score-good" id="performanceScore">89</div>
                                    <div class="text-muted small">out of 100</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-sm-6 col-lg-3">
                            <div class="card cost-card">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="subheader">ROI</div>
                                        <div class="ms-auto">
                                            <span id="roiChange" class="cost-savings">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-sm" width="16" height="16" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                                    <polyline points="7,11 12,6 17,11"/>
                                                    <polyline points="12,18 12,6"/>
                                                </svg>
                                                +23%
                                            </span>
                                        </div>
                                    </div>
                                    <div class="cost-indicator roi-positive" id="roiValue">+287%</div>
                                    <div class="text-muted small">annual return</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Charts Row -->
                    <div class="row mb-4">
                        <div class="col-lg-8">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">Cost & Performance Trends</h3>
                                    <div class="card-actions">
                                        <div class="dropdown">
                                            <button class="btn btn-sm btn-outline-primary dropdown-toggle" data-bs-toggle="dropdown">
                                                Chart Options
                                            </button>
                                            <div class="dropdown-menu">
                                                <a class="dropdown-item" href="#" onclick="updateMainChart('cost')">Cost Trends</a>
                                                <a class="dropdown-item" href="#" onclick="updateMainChart('performance')">Performance Trends</a>
                                                <a class="dropdown-item" href="#" onclick="updateMainChart('efficiency')">Cost Efficiency</a>
                                                <a class="dropdown-item" href="#" onclick="updateMainChart('roi')">ROI Analysis</a>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container large">
                                        <canvas id="mainTrendChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-lg-4">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">Cost Breakdown</h3>
                                </div>
                                <div class="card-body">
                                    <div class="chart-container">
                                        <canvas id="costBreakdownChart"></canvas>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Detailed Analytics -->
                    <div class="row mb-4">
                        <div class="col-lg-6">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">Performance Metrics</h3>
                                </div>
                                <div class="card-body">
                                    <div id="performanceMetrics">
                                        <!-- Performance metrics will be populated here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-lg-6">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">Cost Analysis</h3>
                                </div>
                                <div class="card-body">
                                    <div id="costAnalysis">
                                        <!-- Cost analysis will be populated here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Recommendations & Insights -->
                    <div class="row">
                        <div class="col-lg-8">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">Cost Optimization Recommendations</h3>
                                </div>
                                <div class="card-body">
                                    <div id="recommendations" class="list-group list-group-flush">
                                        <!-- Recommendations will be populated here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-lg-4">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">Quick Actions</h3>
                                </div>
                                <div class="card-body">
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-primary" onclick="generateCostReport()">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                                <path d="M14 3v4a1 1 0 0 0 1 1h4"/>
                                                <path d="M17 21h-10a2 2 0 0 1 -2 -2v-14a2 2 0 0 1 2 -2h7l5 5v11a2 2 0 0 1 -2 2z"/>
                                            </svg>
                                            Generate Cost Report
                                        </button>
                                        
                                        <button class="btn btn-outline-primary" onclick="optimizeLicenses()">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                                <circle cx="12" cy="12" r="3"/>
                                                <path d="M12 1v6m0 6v6"/>
                                                <path d="M21 12h-6m-6 0H3"/>
                                            </svg>
                                            Optimize Licenses
                                        </button>
                                        
                                        <button class="btn btn-outline-success" onclick="forecastCosts()">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="icon me-2" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                                <polyline points="22,12 18,12 15,21 9,3 6,12 2,12"/>
                                            </svg>
                                            Forecast Costs
                                        </button>
                                        
                                        <div class="mt-3 business-only" style="display: none;">
                                            <h4 class="subheader">Budget Status</h4>
                                            <div class="d-flex align-items-center mb-2">
                                                <span class="text-muted small">Monthly Budget:</span>
                                                <span class="ms-auto fw-bold">$1,500</span>
                                            </div>
                                            <div class="d-flex align-items-center mb-2">
                                                <span class="text-muted small">Current Spend:</span>
                                                <span class="ms-auto fw-bold text-success">$1,247</span>
                                            </div>
                                            <div class="d-flex align-items-center mb-2">
                                                <span class="text-muted small">Remaining:</span>
                                                <span class="ms-auto fw-bold text-primary">$253</span>
                                            </div>
                                            <div class="progress mt-2">
                                                <div class="progress-bar bg-success" style="width: 83%" role="progressbar"></div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Tabler JS -->
    <script src="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta17/dist/js/tabler.min.js"></script>
    
    <!-- Configuration -->
    <script src="assets/js/config.js"></script>
    
    <script>
        class CostPerformanceAnalytics {
            constructor() {
                this.apiBase = null;
                this.user = null;
                this.organization = null;
                this.currentPeriod = 'current-month';
                this.currentView = 'combined';
                this.currency = 'usd';
                this.charts = {};
                this.init();
            }
            
            async init() {
                // Resolve API base
                this.apiBase = await window.apiResolver.resolveApiBase();
                
                // Check authentication
                if (!await this.checkAuth()) {
                    window.location.href = 'login.html';
                    return;
                }
                
                // Load user data and analytics
                await this.loadUserData();
                await this.loadAnalyticsData();
                this.initializeCharts();
            }
            
            async checkAuth() {
                const token = localStorage.getItem('mscc_session_token');
                if (!token) return false;
                
                // Check for development session
                if (token.startsWith('dev_')) {
                    const devSession = localStorage.getItem('mscc_dev_session');
                    if (devSession) {
                        this.user = JSON.parse(devSession);
                        this.organization = this.user.organization;
                        return true;
                    }
                    return false;
                }
                
                return false; // Disabled for now
            }
            
            async loadUserData() {
                // Update UI with user info
                document.getElementById('userName').textContent = this.user.name;
                document.getElementById('userRole').textContent = this.organization.name;
                document.getElementById('userAvatar').style.backgroundImage = `url(${this.user.picture})`;
                
                // Update page content based on role
                const analyticsSummary = document.getElementById('analyticsSummary');
                switch(this.organization.type) {
                    case 'individual':
                        analyticsSummary.textContent = 'Your personal cost and performance metrics';
                        // Hide business-only features
                        document.querySelectorAll('.business-only').forEach(el => el.style.display = 'none');
                        break;
                    case 'business':
                        analyticsSummary.textContent = `Cost optimization and performance analytics for ${this.organization.name}`;
                        document.querySelectorAll('.business-only').forEach(el => el.style.display = 'block');
                        break;
                    case 'site-admin':
                        analyticsSummary.textContent = 'Global cost and performance analytics';
                        document.getElementById('adminNav').style.display = 'block';
                        document.querySelectorAll('.business-only').forEach(el => el.style.display = 'block');
                        break;
                }
            }
            
            async loadAnalyticsData() {
                // Generate mock analytics data
                const data = this.generateMockAnalyticsData();
                
                // Update metrics
                this.updateCostMetrics(data);
                this.updatePerformanceMetrics(data);
                this.updateRecommendations(data);
            }
            
            generateMockAnalyticsData() {
                const isIndividual = this.organization.type === 'individual';
                const isAdmin = this.organization.type === 'site-admin';
                
                const baseMultiplier = isIndividual ? 1 : isAdmin ? 100 : 10;
                const costMultiplier = isIndividual ? 25 : isAdmin ? 25000 : 1250;
                
                return {
                    costs: {
                        monthly: costMultiplier + Math.floor(Math.random() * costMultiplier * 0.2),
                        perDevice: Math.floor((costMultiplier / (baseMultiplier * 4)) * 100) / 100,
                        breakdown: {
                            licenses: 0.6,
                            infrastructure: 0.25,
                            support: 0.1,
                            training: 0.03,
                            incidents: 0.02
                        },
                        trends: this.generateCostTrends()
                    },
                    performance: {
                        score: Math.floor(Math.random() * 20) + 75,
                        metrics: {
                            uptime: 99.8 - Math.random() * 0.5,
                            responseTime: 120 + Math.random() * 100,
                            scanEfficiency: 95 + Math.random() * 5,
                            updateCompliance: 92 + Math.random() * 8,
                            threatDetection: 98 + Math.random() * 2
                        },
                        trends: this.generatePerformanceTrends()
                    },
                    roi: {
                        value: 250 + Math.floor(Math.random() * 100),
                        savings: costMultiplier * 0.3,
                        avoidedCosts: costMultiplier * 0.8
                    }
                };
            }
            
            generateCostTrends() {
                const data = [];
                const now = new Date();
                const months = 12;
                
                for (let i = months; i >= 0; i--) {
                    const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                    const baseCost = 1000 + Math.random() * 500;
                    data.push({
                        date: date,
                        cost: baseCost,
                        licenses: baseCost * 0.6,
                        infrastructure: baseCost * 0.25,
                        support: baseCost * 0.1,
                        other: baseCost * 0.05
                    });
                }
                
                return data;
            }
            
            generatePerformanceTrends() {
                const data = [];
                const now = new Date();
                const days = 30;
                
                for (let i = days; i >= 0; i--) {
                    const date = new Date(now.getTime() - (i * 24 * 60 * 60 * 1000));
                    data.push({
                        date: date,
                        score: 80 + Math.random() * 20,
                        uptime: 99 + Math.random(),
                        efficiency: 90 + Math.random() * 10
                    });
                }
                
                return data;
            }
            
            updateCostMetrics(data) {
                const currencySymbol = this.getCurrencySymbol();
                
                // Monthly Cost
                document.getElementById('monthlyCost').textContent = 
                    `${currencySymbol}${data.costs.monthly.toLocaleString()}`;
                
                // Cost per Device
                document.getElementById('costPerDevice').textContent = 
                    `${currencySymbol}${data.costs.perDevice}`;
                
                // Performance Score
                const performanceScore = document.getElementById('performanceScore');
                performanceScore.textContent = data.performance.score;
                performanceScore.className = `performance-score ${this.getScoreClass(data.performance.score)}`;
                
                // ROI
                document.getElementById('roiValue').textContent = `+${data.roi.value}%`;
            }
            
            updatePerformanceMetrics(data) {
                const container = document.getElementById('performanceMetrics');
                const metrics = data.performance.metrics;
                
                container.innerHTML = Object.entries(metrics).map(([key, value]) => {
                    const label = this.formatMetricLabel(key);
                    const formattedValue = this.formatMetricValue(key, value);
                    const percentage = this.getMetricPercentage(key, value);
                    
                    return `
                        <div class="performance-metric">
                            <div>
                                <div class="fw-bold">${label}</div>
                                <div class="text-muted small">${formattedValue}</div>
                            </div>
                            <div class="metric-gauge">
                                <div class="progress">
                                    <div class="progress-bar ${this.getMetricColor(key, value)}" 
                                         style="width: ${percentage}%" role="progressbar"></div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                // Update cost analysis
                this.updateCostAnalysis(data);
            }
            
            updateCostAnalysis(data) {
                const container = document.getElementById('costAnalysis');
                const breakdown = data.costs.breakdown;
                const totalCost = data.costs.monthly;
                
                container.innerHTML = Object.entries(breakdown).map(([category, percentage]) => {
                    const amount = totalCost * percentage;
                    const label = this.formatCostCategory(category);
                    
                    return `
                        <div class="cost-breakdown-item cost-${category} p-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <div class="fw-bold">${label}</div>
                                    <div class="text-muted small">${(percentage * 100).toFixed(1)}% of total</div>
                                </div>
                                <div class="text-end">
                                    <div class="fw-bold">${this.getCurrencySymbol()}${amount.toLocaleString()}</div>
                                    <div class="text-muted small">monthly</div>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            updateRecommendations(data) {
                const container = document.getElementById('recommendations');
                const recommendations = this.generateRecommendations(data);
                
                container.innerHTML = recommendations.map(rec => `
                    <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h4 class="mb-1">${rec.title}</h4>
                                <p class="mb-1">${rec.description}</p>
                                <small class="text-success">Potential savings: ${this.getCurrencySymbol()}${rec.savings}/month</small>
                            </div>
                            <div>
                                <span class="badge bg-${rec.priority === 'high' ? 'danger' : rec.priority === 'medium' ? 'warning' : 'success'}">${rec.priority}</span>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            
            generateRecommendations(data) {
                const recommendations = [
                    {
                        title: 'Optimize License Allocation',
                        description: 'Review unused licenses and redistribute to active users.',
                        savings: Math.floor(data.costs.monthly * 0.1),
                        priority: 'high'
                    },
                    {
                        title: 'Automate Security Updates',
                        description: 'Reduce manual effort and improve compliance with automated patching.',
                        savings: Math.floor(data.costs.monthly * 0.05),
                        priority: 'medium'
                    },
                    {
                        title: 'Consolidate Security Tools',
                        description: 'Reduce tool sprawl by consolidating overlapping security solutions.',
                        savings: Math.floor(data.costs.monthly * 0.15),
                        priority: 'high'
                    },
                    {
                        title: 'Improve Training Programs',
                        description: 'Enhanced user training can reduce incident response costs.',
                        savings: Math.floor(data.costs.monthly * 0.08),
                        priority: 'low'
                    }
                ];
                
                return recommendations;
            }
            
            formatMetricLabel(key) {
                const labels = {
                    uptime: 'System Uptime',
                    responseTime: 'Avg Response Time',
                    scanEfficiency: 'Scan Efficiency',
                    updateCompliance: 'Update Compliance',
                    threatDetection: 'Threat Detection Rate'
                };
                return labels[key] || key;
            }
            
            formatMetricValue(key, value) {
                switch(key) {
                    case 'uptime':
                    case 'scanEfficiency':
                    case 'updateCompliance':
                    case 'threatDetection':
                        return `${value.toFixed(1)}%`;
                    case 'responseTime':
                        return `${Math.floor(value)}ms`;
                    default:
                        return value.toString();
                }
            }
            
            getMetricPercentage(key, value) {
                switch(key) {
                    case 'responseTime':
                        return Math.max(0, 100 - (value / 10)); // Lower is better
                    default:
                        return Math.min(100, value);
                }
            }
            
            getMetricColor(key, value) {
                const percentage = this.getMetricPercentage(key, value);
                if (percentage >= 90) return 'bg-success';
                if (percentage >= 80) return 'bg-warning';
                return 'bg-danger';
            }
            
            formatCostCategory(category) {
                const categories = {
                    licenses: 'Software Licenses',
                    infrastructure: 'Infrastructure',
                    support: 'Support & Maintenance',
                    training: 'Training & Certification',
                    incidents: 'Incident Response'
                };
                return categories[category] || category;
            }
            
            getCurrencySymbol() {
                const symbols = {
                    usd: '$',
                    eur: '€',
                    gbp: '£',
                    cad: 'C$'
                };
                return symbols[this.currency] || '$';
            }
            
            getScoreClass(score) {
                if (score >= 90) return 'score-excellent';
                if (score >= 75) return 'score-good';
                if (score >= 60) return 'score-fair';
                return 'score-poor';
            }
            
            initializeCharts() {
                // Main Trend Chart
                this.charts.mainTrend = new Chart(document.getElementById('mainTrendChart'), {
                    type: 'line',
                    data: {
                        datasets: [{
                            label: 'Monthly Cost',
                            data: [],
                            borderColor: '#0d6efd',
                            backgroundColor: 'rgba(13, 110, 253, 0.1)',
                            yAxisID: 'y',
                            tension: 0.4
                        }, {
                            label: 'Performance Score',
                            data: [],
                            borderColor: '#198754',
                            backgroundColor: 'rgba(25, 135, 84, 0.1)',
                            yAxisID: 'y1',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        interaction: {
                            mode: 'index',
                            intersect: false,
                        },
                        scales: {
                            x: {
                                type: 'time',
                                time: {
                                    unit: 'month'
                                }
                            },
                            y: {
                                type: 'linear',
                                display: true,
                                position: 'left',
                                title: {
                                    display: true,
                                    text: 'Cost ($)'
                                }
                            },
                            y1: {
                                type: 'linear',
                                display: true,
                                position: 'right',
                                title: {
                                    display: true,
                                    text: 'Performance Score'
                                },
                                grid: {
                                    drawOnChartArea: false,
                                },
                            }
                        },
                        plugins: {
                            legend: {
                                position: 'top'
                            }
                        }
                    }
                });
                
                // Cost Breakdown Chart
                this.charts.costBreakdown = new Chart(document.getElementById('costBreakdownChart'), {
                    type: 'doughnut',
                    data: {
                        labels: ['Licenses', 'Infrastructure', 'Support', 'Training', 'Incidents'],
                        datasets: [{
                            data: [60, 25, 10, 3, 2],
                            backgroundColor: [
                                '#0d6efd',
                                '#198754',
                                '#ffc107',
                                '#0dcaf0',
                                '#dc3545'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
                
                this.updateChartsWithData();
            }
            
            updateChartsWithData() {
                const data = this.generateMockAnalyticsData();
                
                // Update main trend chart
                const costTrends = data.costs.trends;
                this.charts.mainTrend.data.datasets[0].data = costTrends.map(d => ({x: d.date, y: d.cost}));
                
                const performanceTrends = data.performance.trends;
                this.charts.mainTrend.data.datasets[1].data = performanceTrends.map(d => ({x: d.date, y: d.score}));
                
                this.charts.mainTrend.update();
                
                // Update cost breakdown chart
                const breakdown = data.costs.breakdown;
                this.charts.costBreakdown.data.datasets[0].data = [
                    breakdown.licenses * 100,
                    breakdown.infrastructure * 100,
                    breakdown.support * 100,
                    breakdown.training * 100,
                    breakdown.incidents * 100
                ];
                this.charts.costBreakdown.update();
            }
        }
        
        // Global functions
        function updateAnalytics() {
            const timePeriod = document.getElementById('timePeriodFilter').value;
            const viewType = document.getElementById('viewTypeFilter').value;
            const currency = document.getElementById('currencyFilter').value;
            
            window.costAnalytics.currentPeriod = timePeriod;
            window.costAnalytics.currentView = viewType;
            window.costAnalytics.currency = currency;
            
            window.costAnalytics.loadAnalyticsData();
            window.costAnalytics.updateChartsWithData();
        }
        
        function refreshData() {
            window.costAnalytics.loadAnalyticsData();
            window.costAnalytics.updateChartsWithData();
        }
        
        function updateMainChart(metric) {
            console.log('Updating main chart to show:', metric);
        }
        
        function exportReport(format) {
            alert(`Exporting report in ${format.toUpperCase()} format`);
        }
        
        function generateCostReport() {
            alert('Generating detailed cost report');
        }
        
        function optimizeLicenses() {
            alert('License optimization analysis started');
        }
        
        function forecastCosts() {
            alert('Cost forecasting analysis started');
        }
        
        function logout() {
            localStorage.removeItem('mscc_session_token');
            localStorage.removeItem('mscc_dev_session');
            window.location.href = 'login.html';
        }
        
        // Initialize
        window.costAnalytics = new CostPerformanceAnalytics();
    </script>
</body>
</html>
