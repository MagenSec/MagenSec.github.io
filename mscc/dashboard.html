<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MagenSec Command Center - Dashboard</title>
    <link rel="icon" type="image/png" href="../assets/favicon.png">
    
    <!-- Tabler CSS -->
    <link href="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta17/dist/css/tabler.min.css" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/@tabler/icons@latest/icons-sprite.svg" rel="stylesheet"/>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <style>
        .navbar-brand img {
            height: 32px;
            margin-right: 0.5rem;
        }
        
        .stat-card {
            transition: all 0.2s;
        }
        
        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 25px rgba(0,0,0,0.1);
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
        }
        
        .activity-item {
            border-left: 3px solid var(--tblr-primary);
            padding-left: 1rem;
            margin-bottom: 1rem;
        }
        
        .activity-time {
            font-size: 0.8rem;
            color: var(--tblr-muted);
        }
        
        .security-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .status-good { color: var(--tblr-success); }
        .status-warning { color: var(--tblr-warning); }
        .status-critical { color: var(--tblr-danger); }
    </style>
</head>
<body>
    <div class="page">
        <!-- Navbar -->
        <header class="navbar navbar-expand-md navbar-dark d-print-none">
            <div class="container-xl">
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar-menu" aria-controls="navbar-menu" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <h1 class="navbar-brand navbar-brand-autodark d-none-navbar-horizontal pe-0 pe-md-3">
                    <a href=".">
                        <img src="../assets/logo.png" alt="MagenSec" class="navbar-brand-image">
                        MagenSec
                    </a>
                </h1>
                <div class="navbar-nav flex-row order-md-last">
                    <div class="d-none d-md-flex">
                        <div class="nav-item dropdown d-none d-md-flex me-3">
                            <a href="#" class="nav-link px-0" data-bs-toggle="dropdown" tabindex="-1" aria-label="Show notifications">
                                <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                    <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                    <path d="M10 5a2 2 0 0 1 4 0a7 7 0 0 1 4 6v3a4 4 0 0 0 2 3h-16a4 4 0 0 0 2 -3v-3a7 7 0 0 1 4 -6"/>
                                    <path d="M9 17v1a3 3 0 0 0 6 0v-1"/>
                                </svg>
                                <span id="notificationBadge" class="badge bg-red"></span>
                            </a>
                            <div class="dropdown-menu dropdown-menu-arrow dropdown-menu-end dropdown-menu-card">
                                <div class="card">
                                    <div class="card-header">
                                        <h3 class="card-title">Security Alerts</h3>
                                    </div>
                                    <div id="notificationList" class="list-group list-group-flush list-group-hoverable">
                                        <!-- Notifications will be loaded here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="nav-item dropdown">
                        <a href="#" class="nav-link d-flex lh-1 text-reset p-0" data-bs-toggle="dropdown" aria-label="Open user menu">
                            <span id="userAvatar" class="avatar avatar-sm" style="background-image: url()"></span>
                            <div class="d-none d-xl-block ps-2">
                                <div id="userName">User</div>
                                <div id="userRole" class="mt-1 small text-muted">Role</div>
                            </div>
                        </a>
                        <div class="dropdown-menu dropdown-menu-end dropdown-menu-arrow">
                            <a href="#" class="dropdown-item">Profile</a>
                            <a href="#" class="dropdown-item">Settings</a>
                            <div class="dropdown-divider"></div>
                            <a href="#" class="dropdown-item" onclick="logout()">Logout</a>
                        </div>
                    </div>
                </div>
                <div class="collapse navbar-collapse" id="navbar-menu">
                    <div class="d-flex flex-column flex-md-row flex-fill align-items-stretch align-items-md-center">
                        <ul class="navbar-nav">
                            <li class="nav-item active">
                                <a class="nav-link" href="#dashboard">
                                    <span class="nav-link-icon d-md-none d-lg-inline-block">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                            <rect x="4" y="4" width="6" height="8" rx="1"/>
                                            <rect x="4" y="16" width="6" height="4" rx="1"/>
                                            <rect x="14" y="4" width="6" height="4" rx="1"/>
                                            <rect x="14" y="12" width="6" height="8" rx="1"/>
                                        </svg>
                                    </span>
                                    <span class="nav-link-title">Dashboard</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#devices">
                                    <span class="nav-link-icon d-md-none d-lg-inline-block">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                            <rect x="3" y="4" width="18" height="12" rx="1"/>
                                            <line x1="7" y1="20" x2="17" y2="20"/>
                                            <line x1="9" y1="16" x2="15" y2="16"/>
                                        </svg>
                                    </span>
                                    <span class="nav-link-title">Devices</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#security">
                                    <span class="nav-link-icon d-md-none d-lg-inline-block">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                            <path d="M12 3a12 12 0 0 0 8.5 3a12 12 0 0 1 -8.5 15a12 12 0 0 1 -8.5 -15a12 12 0 0 0 8.5 -3"/>
                                        </svg>
                                    </span>
                                    <span class="nav-link-title">Security</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="#compliance">
                                    <span class="nav-link-icon d-md-none d-lg-inline-block">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                            <path d="M9 11l3 3l8 -8"/>
                                            <path d="M20 12v6a2 2 0 0 1 -2 2H6a2 2 0 0 1 -2 -2V6a2 2 0 0 1 2 -2h9"/>
                                        </svg>
                                    </span>
                                    <span class="nav-link-title">Compliance</span>
                                </a>
                            </li>
                            <li id="adminNav" class="nav-item" style="display: none;">
                                <a class="nav-link" href="#admin">
                                    <span class="nav-link-icon d-md-none d-lg-inline-block">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                            <circle cx="12" cy="12" r="3"/>
                                            <path d="M12 1v6m0 6v6"/>
                                            <path d="M21 12h-6m-6 0H3"/>
                                        </svg>
                                    </span>
                                    <span class="nav-link-title">Administration</span>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </header>
        
        <!-- Page wrapper -->
        <div class="page-wrapper">
            <!-- Page body -->
            <div class="page-body">
                <div class="container-xl">
                    <!-- Welcome Section -->
                    <div class="row row-deck row-cards mb-4">
                        <div class="col-12">
                            <div class="card">
                                <div class="card-body">
                                    <div class="row align-items-center">
                                        <div class="col">
                                            <h2 id="welcomeMessage" class="card-title mb-1">Welcome back!</h2>
                                            <p id="welcomeDescription" class="text-muted mb-0">Here's your security overview</p>
                                        </div>
                                        <div class="col-auto">
                                            <div id="securityScore" class="d-flex align-items-center">
                                                <div class="text-end me-3">
                                                    <div class="text-muted">Security Score</div>
                                                    <div class="h2 mb-0">--</div>
                                                </div>
                                                <div class="progress progress-sm" style="width: 80px;">
                                                    <div class="progress-bar" style="width: 0%" role="progressbar"></div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Stats Cards -->
                    <div class="row row-deck row-cards mb-4">
                        <div id="statsContainer" class="col-12">
                            <!-- Stats cards will be dynamically inserted here -->
                        </div>
                    </div>
                    
                    <!-- Dashboard Content -->
                    <div class="row row-deck row-cards">
                        <!-- Charts Section -->
                        <div class="col-lg-8">
                            <div class="row row-cards">
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-header">
                                            <h3 class="card-title">Security Trends</h3>
                                        </div>
                                        <div class="card-body">
                                            <div class="chart-container">
                                                <canvas id="trendsChart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h3 class="card-title">Threat Distribution</h3>
                                        </div>
                                        <div class="card-body">
                                            <div class="chart-container">
                                                <canvas id="threatsChart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header">
                                            <h3 class="card-title">Device Status</h3>
                                        </div>
                                        <div class="card-body">
                                            <div class="chart-container">
                                                <canvas id="devicesChart"></canvas>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Activity Feed -->
                        <div class="col-lg-4">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">Recent Activity</h3>
                                </div>
                                <div class="card-body">
                                    <div id="activityFeed">
                                        <!-- Activity items will be loaded here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabler JS -->
    <script src="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta17/dist/js/tabler.min.js"></script>
    
    <!-- Configuration and Data Services -->
    <script src="assets/js/config.js"></script>
    <script src="assets/js/dataService.js"></script>
    
    <script>
        class DashboardManager {
            constructor() {
                this.apiBase = null;
                this.user = null;
                this.organization = null;
                this.charts = {};
                this.init();
            }
            
            async getApiBase() {
                if (!this.apiBase) {
                    this.apiBase = await window.apiResolver.resolveApiBase();
                }
                return this.apiBase;
            }
            
            async init() {
                // Check authentication
                if (!await this.checkAuth()) {
                    window.location.href = 'login.html';
                    return;
                }
                
                // Load user data and dashboard
                await this.loadUserData();
                await this.loadDashboard();
                
                // Set up navigation handling
                this.setupNavigation();
            }
            
            setupNavigation() {
                // Handle hash changes for navigation
                window.addEventListener('hashchange', () => this.handleNavigation());
                
                // Handle initial navigation
                this.handleNavigation();
                
                // Add click handlers to nav links
                document.querySelectorAll('.nav-link[href^="#"]').forEach(link => {
                    link.addEventListener('click', (e) => {
                        e.preventDefault();
                        const hash = link.getAttribute('href');
                        window.location.hash = hash;
                    });
                });
            }
            
            handleNavigation() {
                const hash = window.location.hash.substring(1) || 'dashboard';
                
                // Update active nav item
                document.querySelectorAll('.nav-item').forEach(item => {
                    item.classList.remove('active');
                });
                
                const activeNavItem = document.querySelector(`a[href="#${hash}"]`)?.closest('.nav-item');
                if (activeNavItem) {
                    activeNavItem.classList.add('active');
                }
                
                // Handle different views
                switch(hash) {
                    case 'dashboard':
                        this.showDashboardView();
                        break;
                    case 'devices':
                        this.showDevicesView();
                        break;
                    case 'security':
                        this.showSecurityView();
                        break;
                    case 'compliance':
                        this.showComplianceView();
                        break;
                    case 'admin':
                        this.showAdminView();
                        break;
                    default:
                        this.showDashboardView();
                        break;
                }
            }
            
            showDashboardView() {
                // Show the main dashboard content and hide other views
                this.hideAllViews();
                this.showDashboardContent();
                console.log('Showing dashboard view');
            }
            
            async loadViewFromFile(filename, containerId) {
                try {
                    const response = await fetch(filename);
                    if (!response.ok) {
                        throw new Error(`Failed to load ${filename}: ${response.status}`);
                    }
                    const html = await response.text();
                    
                    // Parse the HTML and extract the body content
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const pageWrapper = doc.querySelector('.page-wrapper') || doc.querySelector('.page-body') || doc.body;
                    
                    // Create container for the view
                    const container = document.createElement('div');
                    container.id = containerId;
                    container.style.display = 'none';
                    container.innerHTML = pageWrapper.innerHTML;
                    
                    // Add to the main page wrapper
                    document.querySelector('.page-wrapper').appendChild(container);
                    
                    // Load and execute any scripts from the loaded content
                    const scripts = doc.querySelectorAll('script');
                    scripts.forEach(script => {
                        if (script.src) {
                            // External script
                            const newScript = document.createElement('script');
                            newScript.src = script.src;
                            newScript.async = true;
                            document.head.appendChild(newScript);
                        } else if (script.textContent) {
                            // Inline script
                            const newScript = document.createElement('script');
                            newScript.textContent = script.textContent;
                            document.head.appendChild(newScript);
                        }
                    });
                    
                    return container;
                } catch (error) {
                    console.error('Error loading view:', error);
                    
                    // Fallback content
                    const container = document.createElement('div');
                    container.id = containerId;
                    container.style.display = 'none';
                    container.innerHTML = `
                        <div class="page-header d-print-none">
                            <div class="container-xl">
                                <div class="row g-2 align-items-center">
                                    <div class="col">
                                        <h2 class="page-title">Content Loading Error</h2>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="page-body">
                            <div class="container-xl">
                                <div class="alert alert-warning">
                                    <h4>Unable to load content</h4>
                                    <p>Error loading ${filename}: ${error.message}</p>
                                </div>
                            </div>
                        </div>
                    `;
                    document.querySelector('.page-wrapper').appendChild(container);
                    return container;
                }
            }
            
            showDashboardContent() {
                const dashboardContent = document.querySelector('.page-body');
                if (dashboardContent) {
                    dashboardContent.style.display = 'block';
                }
            }
            
            hideDashboardContent() {
                const dashboardContent = document.querySelector('.page-body');
                if (dashboardContent) {
                    dashboardContent.style.display = 'none';
                }
            }
            
            async showDevicesView() {
                this.hideAllViews();
                this.hideDashboardContent();
                let devicesContent = document.getElementById('devicesContent');
                if (!devicesContent) {
                    devicesContent = await this.loadViewFromFile('devices.html', 'devicesContent');
                }
                devicesContent.style.display = 'block';
                
                // Initialize devices functionality with Azure Tables integration
                if (window.DeviceManager && window.msccDataService) {
                    // Create a DeviceManager instance with Azure Tables integration
                    const deviceManager = new window.DeviceManager();
                    
                    // Override the loadDevices method to use our dataService
                    deviceManager.loadDevices = async function() {
                        try {
                            console.log('Loading devices from Azure Tables...');
                            const devices = await window.msccDataService.fetchOData('DeviceInventory', null, { 
                                $top: 100,
                                $orderby: 'LastSeen desc'
                            });
                            
                            // Transform Azure Tables data to match DeviceManager format
                            this.devices = devices.map(device => ({
                                id: device.DeviceId || device.RowKey,
                                name: device.DeviceName || device.DeviceId,
                                type: this.getDeviceType(device.OperatingSystem),
                                os: device.OperatingSystem || 'Unknown',
                                status: device.Status?.toLowerCase() || 'offline',
                                lastSeen: device.LastSeen || device.Timestamp,
                                version: device.AgentVersion || '1.0.0',
                                organization: device.Organization || device.PartitionKey,
                                ipAddress: device.IpAddress || 'N/A',
                                location: device.Location || 'Unknown'
                            }));
                            
                            this.filteredDevices = [...this.devices];
                            this.renderDevices();
                            console.log(`Loaded ${this.devices.length} devices from Azure Tables`);
                            
                        } catch (error) {
                            console.error('Failed to load devices from Azure Tables:', error);
                            // Fallback to demo data
                            this.loadDemoDevices();
                        }
                    };
                    
                    // Helper method to determine device type from OS
                    deviceManager.getDeviceType = function(os) {
                        if (!os) return 'workstation';
                        const osLower = os.toLowerCase();
                        if (osLower.includes('server')) return 'server';
                        if (osLower.includes('mobile') || osLower.includes('android') || osLower.includes('ios')) return 'mobile';
                        if (osLower.includes('laptop') || osLower.includes('macbook')) return 'laptop';
                        return 'workstation';
                    };
                    
                    // Demo data fallback
                    deviceManager.loadDemoDevices = function() {
                        this.devices = window.msccDataService.getDemoData('DeviceInventory').map(device => ({
                            id: device.DeviceId,
                            name: device.DeviceName,
                            type: this.getDeviceType(device.OperatingSystem),
                            os: device.OperatingSystem,
                            status: device.Status?.toLowerCase() || 'offline',
                            lastSeen: device.LastSeen,
                            version: device.AgentVersion,
                            organization: device.Organization,
                            ipAddress: 'N/A',
                            location: 'Unknown'
                        }));
                        this.filteredDevices = [...this.devices];
                        this.renderDevices();
                    };
                    
                    // Set user context from dashboard
                    deviceManager.user = this.user;
                    deviceManager.organization = this.organization;
                    
                    // Initialize the device manager
                    window.deviceManager = deviceManager;
                    await deviceManager.loadDevices();
                }
            }
            
            async showSecurityView() {
                this.hideAllViews();
                this.hideDashboardContent();
                let securityContent = document.getElementById('securityContent');
                if (!securityContent) {
                    securityContent = await this.loadViewFromFile('security.html', 'securityContent');
                }
                securityContent.style.display = 'block';
                
                // Initialize security functionality with Azure Tables integration
                if (window.SecurityMonitor && window.msccDataService) {
                    const securityMonitor = new window.SecurityMonitor();
                    
                    // Override loadSecurityEvents to use Azure Tables
                    securityMonitor.loadSecurityEvents = async function() {
                        try {
                            console.log('Loading security events from Azure Tables...');
                            const events = await window.msccDataService.fetchOData('SecurityEvents', null, { 
                                $top: 100,
                                $orderby: 'Timestamp desc',
                                $filter: "Timestamp gt datetime'" + new Date(Date.now() - 30*24*60*60*1000).toISOString() + "'"
                            });
                            
                            // Transform and display security events
                            this.securityEvents = events.map(event => ({
                                id: event.RowKey,
                                type: event.ThreatType || 'Security Event',
                                severity: event.Severity || 'Medium',
                                status: event.Status || 'Detected',
                                device: event.DeviceId,
                                timestamp: event.Timestamp,
                                description: event.Description || event.Message
                            }));
                            
                            this.renderSecurityEvents();
                            console.log(`Loaded ${this.securityEvents.length} security events`);
                            
                        } catch (error) {
                            console.error('Failed to load security events:', error);
                            this.loadDemoSecurityEvents();
                        }
                    };
                    
                    // Demo data fallback
                    securityMonitor.loadDemoSecurityEvents = function() {
                        this.securityEvents = window.msccDataService.getDemoData('SecurityEvents').map(event => ({
                            id: event.RowKey,
                            type: event.ThreatType,
                            severity: event.Severity,
                            status: event.Status,
                            device: event.DeviceId,
                            timestamp: event.Timestamp,
                            description: event.Description
                        }));
                        this.renderSecurityEvents();
                    };
                    
                    // Set user context
                    securityMonitor.user = this.user;
                    securityMonitor.organization = this.organization;
                    
                    window.securityMonitor = securityMonitor;
                    await securityMonitor.loadSecurityEvents();
                }
            }
            
            async showComplianceView() {
                try {
                    console.log('Loading compliance view...');
                    
                    // Load compliance.html content
                    this.hideAllViews();
                    this.hideDashboardContent();
                    let complianceContent = document.getElementById('complianceContent');
                    if (!complianceContent) {
                        complianceContent = await this.loadViewFromFile('compliance.html', 'complianceContent');
                    }
                    complianceContent.style.display = 'block';
                    
                    // Override compliance monitor methods to use Azure Tables data
                    if (window.ComplianceMonitor) {
                        console.log('Integrating Compliance Monitor with Azure Tables...');
                        
                        // Override the compliance data loading to use our data service
                        const originalInit = window.ComplianceMonitor.init;
                        window.ComplianceMonitor.init = async function() {
                            console.log('Initializing compliance monitor with real data...');
                            
                            try {
                                // Load compliance data from Azure Tables
                                await this.loadComplianceData();
                                await this.loadConfigurationData();
                                await this.loadDriftData();
                                this.setupPeriodicUpdates();
                                
                                console.log('Compliance Monitor initialized with Azure Tables integration');
                            } catch (error) {
                                console.error('Failed to initialize compliance monitor:', error);
                                // Fall back to original initialization with demo data
                                return await originalInit.call(this);
                            }
                        };
                        
                        // Enhance compliance data loading
                        const originalLoadComplianceData = window.ComplianceMonitor.loadComplianceData;
                        window.ComplianceMonitor.loadComplianceData = async function() {
                            console.log('Loading compliance data from Azure Tables...');
                            
                            try {
                                // Load compliance telemetry data
                                const complianceData = await window.msccDataService.fetchOData('ComplianceTelemetry', null, {
                                    $orderby: 'Timestamp desc',
                                    $top: 50
                                });
                                
                                console.log('Compliance telemetry loaded:', complianceData.length, 'records');
                                
                                // If no real data, fall back to demo data
                                if (complianceData.length === 0) {
                                    console.log('No compliance data available, using demo data');
                                    return await originalLoadComplianceData.call(this);
                                }
                                
                                // Process real compliance data by framework
                                const frameworkData = this.groupComplianceByFramework(complianceData);
                                
                                // Update each framework display
                                for (const [framework, data] of frameworkData.entries()) {
                                    this.updateFrameworkDisplay(framework, data);
                                }
                                
                            } catch (error) {
                                console.error('Failed to load compliance data:', error);
                                // Fall back to demo data on error
                                return await originalLoadComplianceData.call(this);
                            }
                        };
                        
                        // Add method to group compliance data by framework
                        window.ComplianceMonitor.groupComplianceByFramework = function(complianceData) {
                            const grouped = new Map();
                            
                            complianceData.forEach(item => {
                                const framework = item.Framework?.toLowerCase() || 'unknown';
                                if (!grouped.has(framework)) {
                                    grouped.set(framework, {
                                        score: 0,
                                        status: 'unknown',
                                        issues: 0,
                                        lastAssessment: item.Timestamp
                                    });
                                }
                                
                                // Take the most recent data for each framework
                                const existing = grouped.get(framework);
                                if (new Date(item.Timestamp) > new Date(existing.lastAssessment)) {
                                    grouped.set(framework, {
                                        score: parseInt(item.Score) || 0,
                                        status: this.mapComplianceStatus(parseInt(item.Score) || 0),
                                        issues: parseInt(item.Issues) || 0,
                                        lastAssessment: item.Timestamp
                                    });
                                }
                            });
                            
                            return grouped;
                        };
                        
                        // Add method to map score to status
                        window.ComplianceMonitor.mapComplianceStatus = function(score) {
                            if (score >= 90) return 'excellent';
                            if (score >= 70) return 'good';
                            if (score >= 50) return 'partial';
                            return 'poor';
                        };
                        
                        // Initialize the compliance monitor
                        await window.ComplianceMonitor.init();
                    }
                    
                    // Set active navigation
                    this.setActiveNavigation('compliance');
                    
                } catch (error) {
                    console.error('Failed to load compliance view:', error);
                    this.showError('Failed to load compliance monitoring');
                }
            }
            
            async showAdminView() {
                // For admin users, show admin content inline
                if (this.organization?.type === 'site-admin' || this.organization?.type === 'global-admin') {
                    this.hideAllViews();
                    this.hideDashboardContent();
                    let adminContent = document.getElementById('adminContent');
                    if (!adminContent) {
                        adminContent = await this.loadViewFromFile('admin-dashboard.html', 'adminContent');
                    }
                    adminContent.style.display = 'block';
                    // Initialize admin functionality after content is loaded
                    if (window.AdminDashboard) {
                        window.AdminDashboard.init();
                    }
                } else {
                    // Non-admin users shouldn't see this, redirect to dashboard
                    window.location.hash = 'dashboard';
                }
            }
            
            hideAllViews() {
                const views = ['dashboardContent', 'devicesContent', 'securityContent', 'adminContent'];
                views.forEach(viewId => {
                    const view = document.getElementById(viewId);
                    if (view) view.style.display = 'none';
                });
            }
            
            async checkAuth() {
                const token = localStorage.getItem('mscc_session_token');
                if (!token) return false;
                
                // Check for development session
                if (token.startsWith('dev_')) {
                    const devSession = localStorage.getItem('mscc_dev_session');
                    if (devSession) {
                        this.user = JSON.parse(devSession);
                        this.organization = this.user.organization;
                        return true;
                    }
                    return false;
                }
                
                // Verify with API
                try {
                    const apiBase = await this.getApiBase();
                    const response = await fetch(`${apiBase}/api/oauth/verify`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ sessionToken: token })
                    });
                    
                    if (response.ok) {
                        const session = await response.json();
                        if (session.isValid) {
                            this.user = session.user;
                            this.organization = session.organization;
                            return true;
                        }
                    }
                } catch (error) {
                    console.error('Auth check failed:', error);
                }
                
                return false;
            }
            
            async loadUserData() {
                // Update UI with user info
                document.getElementById('userName').textContent = this.user.name;
                document.getElementById('userRole').textContent = this.organization.name;
                document.getElementById('userAvatar').style.backgroundImage = `url(${this.user.picture})`;
                
                // Update welcome message
                const welcomeMsg = document.getElementById('welcomeMessage');
                const welcomeDesc = document.getElementById('welcomeDescription');
                
                switch(this.organization.type) {
                    case 'individual':
                        welcomeMsg.textContent = `Welcome back, ${this.user.name.split(' ')[0]}!`;
                        welcomeDesc.textContent = 'Your personal security dashboard';
                        break;
                    case 'business':
                        welcomeMsg.textContent = `Good day, ${this.user.name.split(' ')[0]}!`;
                        welcomeDesc.textContent = `Managing security for ${this.organization.name}`;
                        break;
                    case 'global-admin':
                    case 'site-admin':
                        welcomeMsg.textContent = `Hello, ${this.user.name.split(' ')[0]}!`;
                        welcomeDesc.textContent = 'Global security command center';
                        document.getElementById('adminNav').style.display = 'block';
                        break;
                }
            }
            
            async loadDashboard() {
                await this.loadStats();
                await this.loadCharts();
                await this.loadActivity();
                await this.loadNotifications();
            }
            
            async loadStats() {
                try {
                    // Initialize data service if not already done
                    await window.msccDataService.init();
                    
                    // Fetch real data from Azure Tables
                    const [devices, telemetry, securityEvents] = await Promise.all([
                        window.msccDataService.fetchOData('DeviceInventory', null, { $top: 100 }),
                        window.msccDataService.fetchOData('PerfTelemetry', null, { 
                            $top: 100, 
                            $orderby: 'Timestamp desc',
                            $filter: "Timestamp gt datetime'" + new Date(Date.now() - 24*60*60*1000).toISOString() + "'"
                        }),
                        window.msccDataService.fetchOData('SecurityEvents', null, { 
                            $top: 100, 
                            $orderby: 'Timestamp desc',
                            $filter: "Timestamp gt datetime'" + new Date(Date.now() - 30*24*60*60*1000).toISOString() + "'"
                        })
                    ]);
                    
                    // Calculate real statistics
                    const onlineDevices = devices.filter(d => d.Status === 'Online').length;
                    const totalDevices = devices.length;
                    const recentThreats = securityEvents.filter(e => e.Severity === 'High' || e.Severity === 'Critical').length;
                    const pendingUpdates = devices.filter(d => d.Status === 'Maintenance' || d.UpdatePending).length;
                    
                    // Calculate security score based on real data
                    const threatRatio = totalDevices > 0 ? (recentThreats / totalDevices) : 0;
                    const onlineRatio = totalDevices > 0 ? (onlineDevices / totalDevices) : 1;
                    const securityScore = Math.max(20, Math.min(100, Math.round((onlineRatio * 100) - (threatRatio * 20))));
                    
                    const statsData = this.generateStatsFromData({
                        totalDevices,
                        onlineDevices,
                        securityScore,
                        recentThreats,
                        pendingUpdates
                    });
                    
                    this.renderStats(statsData);
                    
                } catch (error) {
                    console.error('Error loading real stats, falling back to demo data:', error);
                    // Fallback to mock data
                    const statsData = this.getMockStats();
                    this.renderStats(statsData);
                }
            }
            
            generateStatsFromData(data) {
                const { totalDevices, onlineDevices, securityScore, recentThreats, pendingUpdates } = data;
                
                return [
                    { 
                        label: 'Devices Protected', 
                        value: totalDevices.toString(), 
                        trend: onlineDevices > totalDevices * 0.8 ? 2 : -1, 
                        trendLabel: 'online now', 
                        progress: totalDevices > 0 ? Math.round((onlineDevices / totalDevices) * 100) : 0, 
                        color: 'primary' 
                    },
                    { 
                        label: 'Security Score', 
                        value: securityScore.toString(), 
                        trend: securityScore > 80 ? 5 : securityScore > 60 ? 0 : -3, 
                        trendLabel: 'current status', 
                        progress: securityScore, 
                        color: securityScore > 80 ? 'success' : securityScore > 60 ? 'warning' : 'danger' 
                    },
                    { 
                        label: 'Threats Detected', 
                        value: recentThreats.toString(), 
                        trend: recentThreats > 5 ? -5 : recentThreats > 0 ? -2 : 2, 
                        trendLabel: 'last 30 days', 
                        progress: Math.min(100, recentThreats * 10), 
                        color: recentThreats > 5 ? 'danger' : recentThreats > 0 ? 'warning' : 'success' 
                    },
                    { 
                        label: 'Updates Pending', 
                        value: pendingUpdates.toString(), 
                        trend: pendingUpdates > 2 ? -3 : 1, 
                        trendLabel: 'action needed', 
                        progress: Math.min(100, pendingUpdates * 20), 
                        color: pendingUpdates > 2 ? 'warning' : 'info' 
                    }
                ];
            }
            
            renderStats(statsData) {
                const container = document.getElementById('statsContainer');
                
                container.innerHTML = '<div class="row">' + 
                    statsData.map(stat => `
                        <div class="col-sm-6 col-lg-3">
                            <div class="card stat-card">
                                <div class="card-body">
                                    <div class="d-flex align-items-center">
                                        <div class="subheader">${stat.label}</div>
                                        <div class="ms-auto lh-1">
                                            <div class="dropdown">
                                                <a class="dropdown-toggle text-muted" href="#" data-bs-toggle="dropdown">
                                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                                        <circle cx="12" cy="12" r="1"/>
                                                        <circle cx="12" cy="19" r="1"/>
                                                        <circle cx="12" cy="5" r="1"/>
                                                    </svg>
                                                </a>
                                                <div class="dropdown-menu dropdown-menu-end">
                                                    <a class="dropdown-item" href="#">View details</a>
                                                    <a class="dropdown-item" href="#">Export data</a>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="h1 mb-3">${stat.value}</div>
                                    <div class="d-flex mb-2">
                                        <div class="text-${stat.trend > 0 ? 'green' : 'red'} d-flex align-items-center lh-1">
                                            ${stat.trend > 0 ? '↗' : '↘'} ${Math.abs(stat.trend)}%
                                            <div class="ms-1">${stat.trendLabel}</div>
                                        </div>
                                    </div>
                                    <div class="progress progress-sm">
                                        <div class="progress-bar bg-${stat.color}" style="width: ${stat.progress}%" role="progressbar"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `).join('') + 
                '</div>';
                
                // Update security score
                const securityScore = document.getElementById('securityScore');
                const score = statsData.find(s => s.label === 'Security Score')?.value || '85';
                securityScore.querySelector('.h2').textContent = score;
                securityScore.querySelector('.progress-bar').style.width = `${score}%`;
            }
            
            getMockStats() {
                switch(this.organization.type) {
                    case 'individual':
                        return [
                            { label: 'Devices Protected', value: '4', trend: 0, trendLabel: 'stable', progress: 80, color: 'primary' },
                            { label: 'Security Score', value: '85', trend: 5, trendLabel: 'this week', progress: 85, color: 'success' },
                            { label: 'Threats Blocked', value: '12', trend: -2, trendLabel: 'this month', progress: 60, color: 'warning' },
                            { label: 'Updates Pending', value: '2', trend: -1, trendLabel: 'this week', progress: 30, color: 'info' }
                        ];
                    case 'business':
                        return [
                            { label: 'Total Devices', value: '47', trend: 8, trendLabel: 'this month', progress: 75, color: 'primary' },
                            { label: 'Security Score', value: '78', trend: 3, trendLabel: 'this week', progress: 78, color: 'success' },
                            { label: 'Active Threats', value: '3', trend: -5, trendLabel: 'this week', progress: 40, color: 'danger' },
                            { label: 'Monthly Cost', value: '$234', trend: 2, trendLabel: 'vs last month', progress: 60, color: 'info' }
                        ];
                    case 'global-admin':
                    case 'site-admin':
                        return [
                            { label: 'Organizations', value: '1,247', trend: 12, trendLabel: 'this month', progress: 90, color: 'primary' },
                            { label: 'Global Threats', value: '156', trend: -8, trendLabel: 'this week', progress: 65, color: 'danger' },
                            { label: 'Platform Health', value: '99.2%', trend: 0.1, trendLabel: 'uptime', progress: 99, color: 'success' },
                            { label: 'Revenue', value: '$124K', trend: 15, trendLabel: 'this month', progress: 85, color: 'info' }
                        ];
                    default:
                        return [
                            { label: 'Devices Protected', value: '4', trend: 0, trendLabel: 'stable', progress: 80, color: 'primary' },
                            { label: 'Security Score', value: '85', trend: 5, trendLabel: 'this week', progress: 85, color: 'success' },
                            { label: 'Threats Blocked', value: '12', trend: -2, trendLabel: 'this month', progress: 60, color: 'warning' },
                            { label: 'Updates Pending', value: '2', trend: -1, trendLabel: 'this week', progress: 30, color: 'info' }
                        ];
                }
            }
            
            async loadCharts() {
                // Trends Chart
                const trendsCtx = document.getElementById('trendsChart').getContext('2d');
                this.charts.trends = new Chart(trendsCtx, {
                    type: 'line',
                    data: {
                        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                        datasets: [{
                            label: 'Security Score',
                            data: [75, 78, 82, 79, 85, 88],
                            borderColor: '#206bc4',
                            backgroundColor: 'rgba(32, 107, 196, 0.1)',
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100
                            }
                        }
                    }
                });
                
                // Threats Chart
                const threatsCtx = document.getElementById('threatsChart').getContext('2d');
                this.charts.threats = new Chart(threatsCtx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Malware', 'Phishing', 'Ransomware', 'Other'],
                        datasets: [{
                            data: [35, 25, 20, 20],
                            backgroundColor: ['#dc3545', '#fd7e14', '#ffc107', '#6c757d']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
                
                // Devices Chart
                const devicesCtx = document.getElementById('devicesChart').getContext('2d');
                this.charts.devices = new Chart(devicesCtx, {
                    type: 'bar',
                    data: {
                        labels: ['Protected', 'Warning', 'Critical'],
                        datasets: [{
                            data: [42, 3, 2],
                            backgroundColor: ['#198754', '#ffc107', '#dc3545']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: false
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            }
            
            async loadActivity() {
                try {
                    // Fetch recent telemetry and security events
                    const [telemetryEvents, securityEvents] = await Promise.all([
                        window.msccDataService.fetchOData('PerfTelemetry', null, { 
                            $top: 10, 
                            $orderby: 'Timestamp desc',
                            $filter: "Timestamp gt datetime'" + new Date(Date.now() - 24*60*60*1000).toISOString() + "'"
                        }),
                        window.msccDataService.fetchOData('SecurityEvents', null, { 
                            $top: 5, 
                            $orderby: 'Timestamp desc',
                            $filter: "Timestamp gt datetime'" + new Date(Date.now() - 24*60*60*1000).toISOString() + "'"
                        })
                    ]);
                    
                    // Combine and format activities
                    const activities = this.formatRealActivities(telemetryEvents, securityEvents);
                    this.renderActivity(activities);
                    
                } catch (error) {
                    console.error('Error loading real activity, falling back to demo data:', error);
                    const activities = this.getMockActivity();
                    this.renderActivity(activities);
                }
            }
            
            formatRealActivities(telemetryEvents, securityEvents) {
                const activities = [];
                
                // Add security events first (highest priority)
                securityEvents.forEach(event => {
                    const timeAgo = this.getTimeAgo(event.Timestamp);
                    let icon, type;
                    
                    switch (event.Severity) {
                        case 'Critical':
                            icon = '🚨';
                            type = 'critical';
                            break;
                        case 'High':
                            icon = '⚠️';
                            type = 'warning';
                            break;
                        case 'Medium':
                            icon = '🔍';
                            type = 'warning';
                            break;
                        default:
                            icon = 'ℹ️';
                            type = 'good';
                    }
                    
                    activities.push({
                        icon,
                        title: event.ThreatType || 'Security Event',
                        description: `${event.Description} on ${event.DeviceId}`,
                        time: timeAgo,
                        type
                    });
                });
                
                // Add telemetry events
                telemetryEvents.slice(0, 8).forEach(event => {
                    const timeAgo = this.getTimeAgo(event.Timestamp);
                    let icon, type;
                    
                    switch (event.EventType) {
                        case 'system-start':
                            icon = '🔄';
                            type = 'good';
                            break;
                        case 'scan-complete':
                            icon = '🛡️';
                            type = 'good';
                            break;
                        case 'threat-detected':
                            icon = '⚠️';
                            type = 'warning';
                            break;
                        case 'update-complete':
                            icon = '✅';
                            type = 'good';
                            break;
                        default:
                            icon = 'ℹ️';
                            type = 'good';
                    }
                    
                    activities.push({
                        icon,
                        title: this.formatEventTitle(event.EventType),
                        description: `${event.Message} on ${event.DeviceId}`,
                        time: timeAgo,
                        type
                    });
                });
                
                // Sort by timestamp and return top 10
                return activities.slice(0, 10);
            }
            
            formatEventTitle(eventType) {
                switch (eventType) {
                    case 'system-start':
                        return 'System started';
                    case 'scan-complete':
                        return 'Security scan completed';
                    case 'threat-detected':
                        return 'Threat detected';
                    case 'update-complete':
                        return 'Update completed';
                    default:
                        return 'System event';
                }
            }
            
            getTimeAgo(timestamp) {
                const now = new Date();
                const eventTime = new Date(timestamp);
                const diffMs = now - eventTime;
                const diffMins = Math.floor(diffMs / (1000 * 60));
                const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                const diffDays = Math.floor(diffMs / (1000 * 60 * 60 * 24));
                
                if (diffMins < 1) return 'Just now';
                if (diffMins < 60) return `${diffMins} minute${diffMins !== 1 ? 's' : ''} ago`;
                if (diffHours < 24) return `${diffHours} hour${diffHours !== 1 ? 's' : ''} ago`;
                return `${diffDays} day${diffDays !== 1 ? 's' : ''} ago`;
            }
            
            renderActivity(activities) {
                const container = document.getElementById('activityFeed');
                
                container.innerHTML = activities.map(activity => `
                    <div class="activity-item">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <div class="security-status">
                                    <span class="status-${activity.type}">${activity.icon}</span>
                                    <strong>${activity.title}</strong>
                                </div>
                                <div class="text-muted small">${activity.description}</div>
                                <div class="activity-time">${activity.time}</div>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
            
            getMockActivity() {
                const commonActivities = [
                    { icon: '🛡️', title: 'Security scan completed', description: 'All devices scanned successfully', time: '2 minutes ago', type: 'good' },
                    { icon: '⚠️', title: 'Update available', description: 'Windows security update pending', time: '1 hour ago', type: 'warning' },
                    { icon: '🔄', title: 'System restart', description: 'DESKTOP-MAIN rebooted', time: '3 hours ago', type: 'good' }
                ];
                
                switch(this.organization.type) {
                    case 'business':
                        return [
                            { icon: '🚨', title: 'Threat detected', description: 'Malware blocked on USER-PC-047', time: '15 minutes ago', type: 'critical' },
                            ...commonActivities,
                            { icon: '👤', title: 'New device enrolled', description: 'LAPTOP-NEW-001 joined network', time: '6 hours ago', type: 'good' }
                        ];
                    case 'global-admin':
                    case 'site-admin':
                        return [
                            { icon: '🌐', title: 'Global threat update', description: 'New ransomware variant detected', time: '5 minutes ago', type: 'warning' },
                            { icon: '📊', title: 'Platform statistics', description: 'Daily report generated', time: '30 minutes ago', type: 'good' },
                            ...commonActivities
                        ];
                    default:
                        return commonActivities;
                }
            }
            
            async loadNotifications() {
                const notifications = this.getMockNotifications();
                const badge = document.getElementById('notificationBadge');
                const list = document.getElementById('notificationList');
                
                badge.textContent = notifications.length;
                badge.style.display = notifications.length > 0 ? 'inline' : 'none';
                
                list.innerHTML = notifications.map(notif => `
                    <a href="#" class="list-group-item list-group-item-action">
                        <div class="row align-items-center">
                            <div class="col-auto">
                                <span class="status-dot status-dot-animated bg-${notif.color}"></span>
                            </div>
                            <div class="col text-truncate">
                                <strong>${notif.title}</strong>
                                <div class="text-muted">${notif.message}</div>
                            </div>
                            <div class="col-auto">
                                <small class="text-muted">${notif.time}</small>
                            </div>
                        </div>
                    </a>
                `).join('');
            }
            
            getMockNotifications() {
                return [
                    { title: 'Security Alert', message: 'Suspicious activity detected', time: '5m', color: 'red' },
                    { title: 'Update Available', message: 'Critical security patch ready', time: '1h', color: 'yellow' },
                    { title: 'Scan Complete', message: 'All systems clean', time: '2h', color: 'green' }
                ];
            }
        }
        
        function logout() {
            localStorage.clear();
            sessionStorage.clear();
            window.location.href = 'login.html';
        }
        
        // Initialize dashboard when page loads
        document.addEventListener('DOMContentLoaded', () => {
            new DashboardManager();
        });
    </script>
</body>
</html>
