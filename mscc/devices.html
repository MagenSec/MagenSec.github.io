<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Device Management - MagenSec Command Center</title>
    <link rel="icon" type="image/png" href="../assets/favicon.png">
    
    <!-- Tabler CSS -->
    <link href="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta17/dist/css/tabler.min.css" rel="stylesheet"/>
    <link href="https://cdn.jsdelivr.net/npm/@tabler/icons@latest/icons-sprite.svg" rel="stylesheet"/>
    
    <style>
        .device-card {
            transition: all 0.2s;
            cursor: pointer;
        }
        
        .device-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 25px rgba(0,0,0,0.1);
        }
        
        .device-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .status-online { color: var(--tblr-success); }
        .status-offline { color: var(--tblr-muted); }
        .status-warning { color: var(--tblr-warning); }
        .status-critical { color: var(--tblr-danger); }
        
        .device-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1rem;
        }
        
        .device-actions {
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .device-card:hover .device-actions {
            opacity: 1;
        }
        
        .filter-bar {
            background: var(--tblr-bg-surface);
            border-radius: var(--tblr-border-radius);
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .search-box {
            position: relative;
        }
        
        .search-box .form-control {
            padding-left: 2.5rem;
        }
        
        .search-box .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--tblr-muted);
        }
    </style>
</head>
<body>
    <div class="page">
        <!-- Navigation Header -->
        <header class="navbar navbar-expand-md navbar-dark d-print-none">
            <div class="container-xl">
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar-menu" aria-controls="navbar-menu" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <h1 class="navbar-brand navbar-brand-autodark d-none-navbar-horizontal pe-0 pe-md-3">
                    <a href="dashboard.html">
                        <img src="../assets/logo.png" alt="MagenSec" class="navbar-brand-image" style="height: 32px; margin-right: 0.5rem;">
                        MagenSec
                    </a>
                </h1>
                <div class="navbar-nav flex-row order-md-last">
                    <div class="nav-item dropdown">
                        <a href="#" class="nav-link d-flex lh-1 text-reset p-0" data-bs-toggle="dropdown" aria-label="Open user menu">
                            <span id="userAvatar" class="avatar avatar-sm"></span>
                            <div class="d-none d-xl-block ps-2">
                                <div id="userName">User</div>
                                <div id="userRole" class="mt-1 small text-muted">Role</div>
                            </div>
                        </a>
                        <div class="dropdown-menu dropdown-menu-end dropdown-menu-arrow">
                            <a href="dashboard.html" class="dropdown-item">Dashboard</a>
                            <a href="#" class="dropdown-item">Settings</a>
                            <div class="dropdown-divider"></div>
                            <a href="#" class="dropdown-item" onclick="logout()">Logout</a>
                        </div>
                    </div>
                </div>
                <div class="collapse navbar-collapse" id="navbar-menu">
                    <div class="d-flex flex-column flex-md-row flex-fill align-items-stretch align-items-md-center">
                        <ul class="navbar-nav">
                            <li class="nav-item">
                                <a class="nav-link" href="dashboard.html">
                                    <span class="nav-link-icon d-md-none d-lg-inline-block">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                            <rect x="4" y="4" width="6" height="8" rx="1"/>
                                            <rect x="4" y="16" width="6" height="4" rx="1"/>
                                            <rect x="14" y="4" width="6" height="4" rx="1"/>
                                            <rect x="14" y="12" width="6" height="8" rx="1"/>
                                        </svg>
                                    </span>
                                    <span class="nav-link-title">Dashboard</span>
                                </a>
                            </li>
                            <li class="nav-item active">
                                <a class="nav-link" href="devices.html">
                                    <span class="nav-link-icon d-md-none d-lg-inline-block">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                            <rect x="3" y="4" width="18" height="12" rx="1"/>
                                            <line x1="7" y1="20" x2="17" y2="20"/>
                                            <line x1="9" y1="16" x2="15" y2="16"/>
                                        </svg>
                                    </span>
                                    <span class="nav-link-title">Devices</span>
                                </a>
                            </li>
                            <li class="nav-item">
                                <a class="nav-link" href="security.html">
                                    <span class="nav-link-icon d-md-none d-lg-inline-block">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                            <path d="M12 3a12 12 0 0 0 8.5 3a12 12 0 0 1 -8.5 15a12 12 0 0 1 -8.5 -15a12 12 0 0 0 8.5 -3"/>
                                        </svg>
                                    </span>
                                    <span class="nav-link-title">Security</span>
                                </a>
                            </li>
                            <li id="adminNav" class="nav-item" style="display: none;">
                                <a class="nav-link" href="admin.html">
                                    <span class="nav-link-icon d-md-none d-lg-inline-block">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                            <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                            <circle cx="12" cy="12" r="3"/>
                                            <path d="M12 1v6m0 6v6"/>
                                            <path d="M21 12h-6m-6 0H3"/>
                                        </svg>
                                    </span>
                                    <span class="nav-link-title">Administration</span>
                                </a>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </header>
        
        <!-- Page Content -->
        <div class="page-wrapper">
            <div class="page-header d-print-none">
                <div class="container-xl">
                    <div class="row g-2 align-items-center">
                        <div class="col">
                            <h2 class="page-title">Device Management</h2>
                            <div class="text-muted mt-1" id="deviceSummary">Managing devices for your organization</div>
                        </div>
                        <div class="col-auto ms-auto d-print-none">
                            <div class="btn-list">
                                <button class="btn btn-primary" onclick="refreshDevices()">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                        <path d="M19.933 13.041a8 8 0 1 1 -9.925 -8.788c3.899 -1 7.935 1.007 9.425 4.747"/>
                                        <path d="M20 4v5h-5"/>
                                    </svg>
                                    Refresh
                                </button>
                                <button id="addDeviceBtn" class="btn btn-success" style="display: none;" onclick="addDevice()">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                        <line x1="12" y1="5" x2="12" y2="19"/>
                                        <line x1="5" y1="12" x2="19" y2="12"/>
                                    </svg>
                                    Add Device
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="page-body">
                <div class="container-xl">
                    <!-- Filter Bar -->
                    <div class="filter-bar">
                        <div class="row g-3 align-items-center">
                            <div class="col-md-4">
                                <div class="search-box">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="search-icon icon" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                        <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                        <circle cx="10" cy="10" r="7"/>
                                        <path d="M21 21l-6-6"/>
                                    </svg>
                                    <input type="text" class="form-control" placeholder="Search devices..." id="searchInput" onkeyup="filterDevices()">
                                </div>
                            </div>
                            <div class="col-md-2">
                                <select class="form-select" id="statusFilter" onchange="filterDevices()">
                                    <option value="">All Status</option>
                                    <option value="online">Online</option>
                                    <option value="offline">Offline</option>
                                    <option value="warning">Warning</option>
                                    <option value="critical">Critical</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <select class="form-select" id="typeFilter" onchange="filterDevices()">
                                    <option value="">All Types</option>
                                    <option value="workstation">Workstation</option>
                                    <option value="laptop">Laptop</option>
                                    <option value="server">Server</option>
                                    <option value="mobile">Mobile</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <select class="form-select" id="osFilter" onchange="filterDevices()">
                                    <option value="">All OS</option>
                                    <option value="windows">Windows</option>
                                    <option value="macos">macOS</option>
                                    <option value="linux">Linux</option>
                                    <option value="android">Android</option>
                                    <option value="ios">iOS</option>
                                </select>
                            </div>
                            <div class="col-md-2">
                                <div class="form-label">View:</div>
                                <div class="btn-group" role="group">
                                    <button type="button" class="btn btn-outline-primary active" onclick="setView('grid')">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="16" height="16" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                            <rect x="4" y="4" width="6" height="6" rx="1"/>
                                            <rect x="14" y="4" width="6" height="6" rx="1"/>
                                            <rect x="4" y="14" width="6" height="6" rx="1"/>
                                            <rect x="14" y="14" width="6" height="6" rx="1"/>
                                        </svg>
                                    </button>
                                    <button type="button" class="btn btn-outline-primary" onclick="setView('list')">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="16" height="16" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                            <line x1="8" y1="6" x2="21" y2="6"/>
                                            <line x1="8" y1="12" x2="21" y2="12"/>
                                            <line x1="8" y1="18" x2="21" y2="18"/>
                                            <line x1="3" y1="6" x2="3.01" y2="6"/>
                                            <line x1="3" y1="12" x2="3.01" y2="12"/>
                                            <line x1="3" y1="18" x2="3.01" y2="18"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Devices Grid View -->
                    <div id="devicesGridView" class="device-grid">
                        <!-- Devices will be populated here -->
                    </div>
                    
                    <!-- Devices List View -->
                    <div id="devicesListView" style="display: none;">
                        <div class="card">
                            <div class="table-responsive">
                                <table class="table table-vcenter card-table">
                                    <thead>
                                        <tr>
                                            <th>Device</th>
                                            <th>Status</th>
                                            <th>Type</th>
                                            <th>OS</th>
                                            <th>Last Seen</th>
                                            <th>Security Score</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="devicesTableBody">
                                        <!-- Table rows will be populated here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Loading State -->
                    <div id="loadingState" class="text-center py-5" style="display: none;">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                        <div class="mt-3 text-muted">Loading devices...</div>
                    </div>
                    
                    <!-- Empty State -->
                    <div id="emptyState" class="text-center py-5" style="display: none;">
                        <div class="empty-icon mb-3">
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-lg text-muted" width="96" height="96" viewBox="0 0 24 24" stroke-width="1" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
                                <rect x="3" y="4" width="18" height="12" rx="1"/>
                                <line x1="7" y1="20" x2="17" y2="20"/>
                                <line x1="9" y1="16" x2="15" y2="16"/>
                            </svg>
                        </div>
                        <h3 class="empty-title">No devices found</h3>
                        <p class="empty-subtitle text-muted">
                            No devices match your current filters, or no devices are registered yet.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Tabler JS -->
    <script src="https://cdn.jsdelivr.net/npm/@tabler/core@1.0.0-beta17/dist/js/tabler.min.js"></script>
    
    <!-- Configuration -->
    <script src="assets/js/config.js"></script>
    
    <script>
        class DeviceManager {
            constructor() {
                this.apiBase = null;
                this.user = null;
                this.organization = null;
                this.devices = [];
                this.filteredDevices = [];
                this.currentView = 'grid';
                this.init();
            }
            
            async init() {
                // Resolve API base
                this.apiBase = await window.apiResolver.resolveApiBase();
                
                // Check authentication
                if (!await this.checkAuth()) {
                    window.location.href = 'login.html';
                    return;
                }
                
                // Load user data and devices
                await this.loadUserData();
                await this.loadDevices();
            }
            
            async checkAuth() {
                const token = localStorage.getItem('mscc_session_token');
                if (!token) return false;
                
                // Check for development session
                if (token.startsWith('dev_')) {
                    const devSession = localStorage.getItem('mscc_dev_session');
                    if (devSession) {
                        this.user = JSON.parse(devSession);
                        this.organization = this.user.organization;
                        return true;
                    }
                    return false;
                }
                
                // Verify with API (when OAuth is working)
                return false; // Disabled for now
            }
            
            async loadUserData() {
                // Update UI with user info
                document.getElementById('userName').textContent = this.user.name;
                document.getElementById('userRole').textContent = this.organization.name;
                document.getElementById('userAvatar').style.backgroundImage = `url(${this.user.picture})`;
                
                // Update page content based on role
                const deviceSummary = document.getElementById('deviceSummary');
                switch(this.organization.type) {
                    case 'individual':
                        deviceSummary.textContent = 'Your personal devices';
                        break;
                    case 'business':
                        deviceSummary.textContent = `Managing devices for ${this.organization.name}`;
                        document.getElementById('addDeviceBtn').style.display = 'inline-block';
                        break;
                    case 'site-admin':
                        deviceSummary.textContent = 'Global device management';
                        document.getElementById('adminNav').style.display = 'block';
                        document.getElementById('addDeviceBtn').style.display = 'inline-block';
                        break;
                }
            }
            
            async loadDevices() {
                this.showLoading(true);
                
                // Generate mock devices based on user role
                this.devices = this.generateMockDevices();
                this.filteredDevices = [...this.devices];
                
                this.showLoading(false);
                this.renderDevices();
            }
            
            generateMockDevices() {
                const deviceTypes = ['workstation', 'laptop', 'server', 'mobile'];
                const osTypes = ['windows', 'macos', 'linux', 'android', 'ios'];
                const statuses = ['online', 'offline', 'warning', 'critical'];
                
                const baseDevices = [];
                const deviceCount = this.organization.type === 'individual' ? 3 : 
                                  this.organization.type === 'business' ? 12 : 25;
                
                for (let i = 1; i <= deviceCount; i++) {
                    const type = deviceTypes[Math.floor(Math.random() * deviceTypes.length)];
                    const os = this.getCompatibleOS(type);
                    const status = statuses[Math.floor(Math.random() * statuses.length)];
                    
                    baseDevices.push({
                        id: `device-${i}`,
                        name: this.generateDeviceName(type, i),
                        type: type,
                        os: os,
                        status: status,
                        lastSeen: this.generateLastSeen(),
                        securityScore: Math.floor(Math.random() * 40) + 60, // 60-100
                        vulnerabilities: Math.floor(Math.random() * 10),
                        owner: this.organization.type === 'individual' ? this.user.name : 
                               this.generateOwnerName(),
                        location: this.generateLocation(),
                        ipAddress: this.generateIP(),
                        version: this.generateVersion(os)
                    });
                }
                
                return baseDevices;
            }
            
            getCompatibleOS(type) {
                const compatible = {
                    workstation: ['windows', 'linux'],
                    laptop: ['windows', 'macos', 'linux'],
                    server: ['windows', 'linux'],
                    mobile: ['android', 'ios']
                };
                const options = compatible[type];
                return options[Math.floor(Math.random() * options.length)];
            }
            
            generateDeviceName(type, index) {
                const names = {
                    workstation: [`WS-${String(index).padStart(3, '0')}`, `DESK-${index}`, `PC-${index}`],
                    laptop: [`LT-${String(index).padStart(3, '0')}`, `LAPTOP-${index}`, `NB-${index}`],
                    server: [`SRV-${String(index).padStart(3, '0')}`, `SERVER-${index}`, `DB-${index}`],
                    mobile: [`PHONE-${index}`, `MOBILE-${index}`, `DEVICE-${index}`]
                };
                const options = names[type];
                return options[Math.floor(Math.random() * options.length)];
            }
            
            generateLastSeen() {
                const now = new Date();
                const hoursAgo = Math.floor(Math.random() * 72); // 0-72 hours ago
                const lastSeen = new Date(now.getTime() - (hoursAgo * 60 * 60 * 1000));
                return lastSeen.toISOString();
            }
            
            generateOwnerName() {
                const names = ['John Smith', 'Sarah Johnson', 'Mike Chen', 'Emily Rodriguez', 'David Wilson', 'Lisa Anderson'];
                return names[Math.floor(Math.random() * names.length)];
            }
            
            generateLocation() {
                const locations = ['Office Floor 1', 'Office Floor 2', 'Remote', 'Home Office', 'Conference Room A', 'Data Center'];
                return locations[Math.floor(Math.random() * locations.length)];
            }
            
            generateIP() {
                return `192.168.${Math.floor(Math.random() * 255)}.${Math.floor(Math.random() * 255)}`;
            }
            
            generateVersion(os) {
                const versions = {
                    windows: ['Windows 11 Pro', 'Windows 10 Enterprise', 'Windows Server 2022'],
                    macos: ['macOS Sonoma 14.0', 'macOS Ventura 13.6', 'macOS Monterey 12.7'],
                    linux: ['Ubuntu 22.04 LTS', 'CentOS 8', 'Red Hat Enterprise Linux 9'],
                    android: ['Android 14', 'Android 13', 'Android 12'],
                    ios: ['iOS 17.0', 'iOS 16.7', 'iOS 15.8']
                };
                const options = versions[os];
                return options[Math.floor(Math.random() * options.length)];
            }
            
            renderDevices() {
                if (this.filteredDevices.length === 0) {
                    this.showEmptyState(true);
                    return;
                }
                
                this.showEmptyState(false);
                
                if (this.currentView === 'grid') {
                    this.renderGridView();
                } else {
                    this.renderListView();
                }
            }
            
            renderGridView() {
                const container = document.getElementById('devicesGridView');
                container.innerHTML = this.filteredDevices.map(device => this.createDeviceCard(device)).join('');
            }
            
            renderListView() {
                const tbody = document.getElementById('devicesTableBody');
                tbody.innerHTML = this.filteredDevices.map(device => this.createDeviceRow(device)).join('');
            }
            
            createDeviceCard(device) {
                const statusClass = `status-${device.status}`;
                const statusIcon = this.getStatusIcon(device.status);
                const osIcon = this.getOSIcon(device.os);
                const lastSeenText = this.formatLastSeen(device.lastSeen);
                
                return `
                    <div class="device-card card" onclick="viewDevice('${device.id}')">
                        <div class="card-body">
                            <div class="d-flex align-items-start justify-content-between mb-3">
                                <div class="d-flex align-items-center">
                                    <div class="avatar avatar-lg me-3" style="background: var(--tblr-primary-lt);">
                                        ${osIcon}
                                    </div>
                                    <div>
                                        <h3 class="card-title mb-1">${device.name}</h3>
                                        <div class="text-muted small">${device.type} • ${device.version}</div>
                                    </div>
                                </div>
                                <div class="device-actions">
                                    <div class="dropdown">
                                        <button class="btn btn-sm btn-outline-primary" data-bs-toggle="dropdown">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="icon" width="16" height="16" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
                                                <circle cx="12" cy="12" r="1"/>
                                                <circle cx="12" cy="5" r="1"/>
                                                <circle cx="12" cy="19" r="1"/>
                                            </svg>
                                        </button>
                                        <div class="dropdown-menu">
                                            <a class="dropdown-item" href="#" onclick="event.stopPropagation(); viewDevice('${device.id}')">View Details</a>
                                            <a class="dropdown-item" href="#" onclick="event.stopPropagation(); scanDevice('${device.id}')">Run Scan</a>
                                            <a class="dropdown-item" href="#" onclick="event.stopPropagation(); updateDevice('${device.id}')">Update</a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-6">
                                    <div class="device-status ${statusClass}">
                                        ${statusIcon}
                                        <span class="text-capitalize">${device.status}</span>
                                    </div>
                                    <div class="text-muted small">Status</div>
                                </div>
                                <div class="col-6">
                                    <div class="fw-bold">${device.securityScore}/100</div>
                                    <div class="text-muted small">Security Score</div>
                                </div>
                            </div>
                            
                            <div class="row">
                                <div class="col-6">
                                    <div class="text-muted small">Last Seen</div>
                                    <div class="small">${lastSeenText}</div>
                                </div>
                                <div class="col-6">
                                    <div class="text-muted small">Vulnerabilities</div>
                                    <div class="small ${device.vulnerabilities > 5 ? 'text-danger' : device.vulnerabilities > 2 ? 'text-warning' : 'text-success'}">
                                        ${device.vulnerabilities} found
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            createDeviceRow(device) {
                const statusClass = `status-${device.status}`;
                const statusIcon = this.getStatusIcon(device.status);
                const osIcon = this.getOSIcon(device.os);
                const lastSeenText = this.formatLastSeen(device.lastSeen);
                
                return `
                    <tr onclick="viewDevice('${device.id}')" style="cursor: pointer;">
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="avatar avatar-sm me-3" style="background: var(--tblr-primary-lt);">
                                    ${osIcon}
                                </div>
                                <div>
                                    <div class="fw-bold">${device.name}</div>
                                    <div class="text-muted small">${device.owner} • ${device.location}</div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div class="device-status ${statusClass}">
                                ${statusIcon}
                                <span class="text-capitalize">${device.status}</span>
                            </div>
                        </td>
                        <td class="text-capitalize">${device.type}</td>
                        <td>${device.version}</td>
                        <td>${lastSeenText}</td>
                        <td>
                            <div class="d-flex align-items-center">
                                <div class="me-2">${device.securityScore}/100</div>
                                <div class="progress" style="width: 60px;">
                                    <div class="progress-bar ${device.securityScore >= 80 ? 'bg-success' : device.securityScore >= 60 ? 'bg-warning' : 'bg-danger'}" 
                                         style="width: ${device.securityScore}%" role="progressbar"></div>
                                </div>
                            </div>
                        </td>
                        <td>
                            <div class="dropdown">
                                <button class="btn btn-sm btn-outline-primary" data-bs-toggle="dropdown" onclick="event.stopPropagation()">
                                    Actions
                                </button>
                                <div class="dropdown-menu">
                                    <a class="dropdown-item" href="#" onclick="event.stopPropagation(); viewDevice('${device.id}')">View Details</a>
                                    <a class="dropdown-item" href="#" onclick="event.stopPropagation(); scanDevice('${device.id}')">Run Scan</a>
                                    <a class="dropdown-item" href="#" onclick="event.stopPropagation(); updateDevice('${device.id}')">Update</a>
                                </div>
                            </div>
                        </td>
                    </tr>
                `;
            }
            
            getStatusIcon(status) {
                const icons = {
                    online: '<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-sm" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/></svg>',
                    offline: '<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-sm" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/></svg>',
                    warning: '<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-sm" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M12 9v2m0 4h.01M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0z"/></svg>',
                    critical: '<svg xmlns="http://www.w3.org/2000/svg" class="icon icon-sm" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M12 9v2m0 4h.01M21 12a9 9 0 1 1-18 0 9 9 0 0 1 18 0z"/></svg>'
                };
                return icons[status] || icons.offline;
            }
            
            getOSIcon(os) {
                const icons = {
                    windows: '<svg xmlns="http://www.w3.org/2000/svg" class="icon" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="8" height="8" rx="1"/><rect x="13" y="3" width="8" height="8" rx="1"/><rect x="3" y="13" width="8" height="8" rx="1"/><rect x="13" y="13" width="8" height="8" rx="1"/></svg>',
                    macos: '<svg xmlns="http://www.w3.org/2000/svg" class="icon" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 -6 6c0 6 6 12 6 12s6 -6 6 -12a6 6 0 0 0 -6 -6"/><circle cx="12" cy="9" r="2"/></svg>',
                    linux: '<svg xmlns="http://www.w3.org/2000/svg" class="icon" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="9" y1="9" x2="9.01" y2="9"/><line x1="15" y1="9" x2="15.01" y2="9"/><path d="M8 13a4 4 0 1 0 8 0m0 0V9a4 4 0 0 0-8 0v4"/></svg>',
                    android: '<svg xmlns="http://www.w3.org/2000/svg" class="icon" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"/><line x1="12" y1="18" x2="12.01" y2="18"/></svg>',
                    ios: '<svg xmlns="http://www.w3.org/2000/svg" class="icon" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round"><rect x="5" y="2" width="14" height="20" rx="2" ry="2"/><line x1="12" y1="18" x2="12.01" y2="18"/></svg>'
                };
                return icons[os] || icons.windows;
            }
            
            formatLastSeen(lastSeen) {
                const date = new Date(lastSeen);
                const now = new Date();
                const diffMs = now - date;
                const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                
                if (diffHours < 1) return 'Just now';
                if (diffHours < 24) return `${diffHours}h ago`;
                const diffDays = Math.floor(diffHours / 24);
                if (diffDays < 7) return `${diffDays}d ago`;
                return date.toLocaleDateString();
            }
            
            showLoading(show) {
                document.getElementById('loadingState').style.display = show ? 'block' : 'none';
                document.getElementById('devicesGridView').style.display = show ? 'none' : 'block';
                document.getElementById('devicesListView').style.display = show ? 'none' : 'block';
            }
            
            showEmptyState(show) {
                document.getElementById('emptyState').style.display = show ? 'block' : 'none';
                document.getElementById('devicesGridView').style.display = show ? 'none' : 'block';
                document.getElementById('devicesListView').style.display = show ? 'none' : 'block';
            }
        }
        
        // Global functions
        function filterDevices() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const status = document.getElementById('statusFilter').value;
            const type = document.getElementById('typeFilter').value;
            const os = document.getElementById('osFilter').value;
            
            window.deviceManager.filteredDevices = window.deviceManager.devices.filter(device => {
                const matchesSearch = device.name.toLowerCase().includes(search) || 
                                    device.owner.toLowerCase().includes(search);
                const matchesStatus = !status || device.status === status;
                const matchesType = !type || device.type === type;
                const matchesOS = !os || device.os === os;
                
                return matchesSearch && matchesStatus && matchesType && matchesOS;
            });
            
            window.deviceManager.renderDevices();
        }
        
        function setView(view) {
            window.deviceManager.currentView = view;
            
            // Update button states
            document.querySelectorAll('.btn-group .btn').forEach(btn => btn.classList.remove('active'));
            event.target.closest('.btn').classList.add('active');
            
            // Show/hide views
            document.getElementById('devicesGridView').style.display = view === 'grid' ? 'block' : 'none';
            document.getElementById('devicesListView').style.display = view === 'list' ? 'block' : 'none';
            
            window.deviceManager.renderDevices();
        }
        
        function refreshDevices() {
            window.deviceManager.loadDevices();
        }
        
        function addDevice() {
            alert('Add Device functionality would be implemented here');
        }
        
        function viewDevice(deviceId) {
            alert(`View details for device: ${deviceId}`);
        }
        
        function scanDevice(deviceId) {
            alert(`Run security scan for device: ${deviceId}`);
        }
        
        function updateDevice(deviceId) {
            alert(`Update device: ${deviceId}`);
        }
        
        function logout() {
            localStorage.removeItem('mscc_session_token');
            localStorage.removeItem('mscc_dev_session');
            window.location.href = 'login.html';
        }
        
        // Initialize
        window.deviceManager = new DeviceManager();
    </script>
</body>
</html>
